<?php
 function is_subdomain_install() { if ( defined( 'SUBDOMAIN_INSTALL' ) ) { return SUBDOMAIN_INSTALL; } return ( defined( 'VHOST' ) && 'yes' === VHOST ); } function wp_get_active_network_plugins() { $active_plugins = (array) get_site_option( 'active_sitewide_plugins', array() ); if ( empty( $active_plugins ) ) { return array(); } $plugins = array(); $active_plugins = array_keys( $active_plugins ); sort( $active_plugins ); foreach ( $active_plugins as $plugin ) { if ( ! validate_file( $plugin ) && str_ends_with( $plugin, '.php' ) && file_exists( WP_PLUGIN_DIR . '/' . $plugin ) ) { $plugins[] = WP_PLUGIN_DIR . '/' . $plugin; } } return $plugins; } function ms_site_check() { $check = apply_filters( 'ms_site_check', null ); if ( null !== $check ) { return true; } if ( is_super_admin() ) { return true; } $blog = get_site(); if ( '1' == $blog->deleted ) { if ( file_exists( WP_CONTENT_DIR . '/blog-deleted.php' ) ) { return WP_CONTENT_DIR . '/blog-deleted.php'; } else { wp_die( __( 'This site is no longer available.' ), '', array( 'response' => 410 ) ); } } if ( '2' == $blog->deleted ) { if ( file_exists( WP_CONTENT_DIR . '/blog-inactive.php' ) ) { return WP_CONTENT_DIR . '/blog-inactive.php'; } else { $admin_email = str_replace( '@', ' AT ', get_site_option( 'admin_email', 'support@' . get_network()->domain ) ); wp_die( sprintf( __( 'This site has not been activated yet. If you are having problems activating your site, please contact %s.' ), sprintf( '<a href="mailto:%1$s">%1$s</a>', $admin_email ) ) ); } } if ( '1' == $blog->archived || '1' == $blog->spam ) { if ( file_exists( WP_CONTENT_DIR . '/blog-suspended.php' ) ) { return WP_CONTENT_DIR . '/blog-suspended.php'; } else { wp_die( __( 'This site has been archived or suspended.' ), '', array( 'response' => 410 ) ); } } return true; } function get_network_by_path( $domain, $path, $segments = null ) { return WP_Network::get_by_path( $domain, $path, $segments ); } function get_site_by_path( $domain, $path, $segments = null ) { $path_segments = array_filter( explode( '/', trim( $path, '/' ) ) ); $segments = apply_filters( 'site_by_path_segments_count', $segments, $domain, $path ); if ( null !== $segments && count( $path_segments ) > $segments ) { $path_segments = array_slice( $path_segments, 0, $segments ); } $paths = array(); while ( count( $path_segments ) ) { $paths[] = '/' . implode( '/', $path_segments ) . '/'; array_pop( $path_segments ); } $paths[] = '/'; $pre = apply_filters( 'pre_get_site_by_path', null, $domain, $path, $segments, $paths ); if ( null !== $pre ) { if ( false !== $pre && ! $pre instanceof WP_Site ) { $pre = new WP_Site( $pre ); } return $pre; } $domains = array( $domain ); if ( str_starts_with( $domain, 'www.' ) ) { $domains[] = substr( $domain, 4 ); } $args = array( 'number' => 1, 'update_site_meta_cache' => false, ); if ( count( $domains ) > 1 ) { $args['domain__in'] = $domains; $args['orderby']['domain_length'] = 'DESC'; } else { $args['domain'] = array_shift( $domains ); } if ( count( $paths ) > 1 ) { $args['path__in'] = $paths; $args['orderby']['path_length'] = 'DESC'; } else { $args['path'] = array_shift( $paths ); } $result = get_sites( $args ); $site = array_shift( $result ); if ( $site ) { return $site; } return false; } function ms_load_current_site_and_network( $domain, $path, $subdomain = false ) { global $current_site, $current_blog; if ( defined( 'DOMAIN_CURRENT_SITE' ) && defined( 'PATH_CURRENT_SITE' ) ) { $current_site = new stdClass(); $current_site->id = defined( 'SITE_ID_CURRENT_SITE' ) ? SITE_ID_CURRENT_SITE : 1; $current_site->domain = DOMAIN_CURRENT_SITE; $current_site->path = PATH_CURRENT_SITE; if ( defined( 'BLOG_ID_CURRENT_SITE' ) ) { $current_site->blog_id = BLOG_ID_CURRENT_SITE; } elseif ( defined( 'BLOGID_CURRENT_SITE' ) ) { $current_site->blog_id = BLOGID_CURRENT_SITE; } if ( 0 === strcasecmp( $current_site->domain, $domain ) && 0 === strcasecmp( $current_site->path, $path ) ) { $current_blog = get_site_by_path( $domain, $path ); } elseif ( '/' !== $current_site->path && 0 === strcasecmp( $current_site->domain, $domain ) && 0 === stripos( $path, $current_site->path ) ) { $current_blog = get_site_by_path( $domain, $path, 1 + count( explode( '/', trim( $current_site->path, '/' ) ) ) ); } else { $current_blog = get_site_by_path( $domain, $path, 1 ); } } elseif ( ! $subdomain ) { $current_site = wp_cache_get( 'current_network', 'site-options' ); if ( ! $current_site ) { $networks = get_networks( array( 'number' => 2 ) ); if ( count( $networks ) === 1 ) { $current_site = array_shift( $networks ); wp_cache_add( 'current_network', $current_site, 'site-options' ); } elseif ( empty( $networks ) ) { return false; } } if ( empty( $current_site ) ) { $current_site = WP_Network::get_by_path( $domain, $path, 1 ); } if ( empty( $current_site ) ) { do_action( 'ms_network_not_found', $domain, $path ); return false; } elseif ( $path === $current_site->path ) { $current_blog = get_site_by_path( $domain, $path ); } else { $current_blog = get_site_by_path( $domain, $path, substr_count( $current_site->path, '/' ) ); } } else { $current_blog = get_site_by_path( $domain, $path, 1 ); if ( $current_blog ) { $current_site = WP_Network::get_instance( $current_blog->site_id ? $current_blog->site_id : 1 ); } else { $current_site = WP_Network::get_by_path( $domain, $path, 1 ); } } if ( $current_blog && $current_blog->site_id != $current_site->id ) { $current_site = WP_Network::get_instance( $current_blog->site_id ); } if ( empty( $current_site ) ) { do_action( 'ms_network_not_found', $domain, $path ); return false; } if ( empty( $current_blog ) && wp_installing() ) { $current_blog = new stdClass(); $current_blog->blog_id = 1; $blog_id = 1; $current_blog->public = 1; } if ( empty( $current_blog ) ) { $scheme = is_ssl() ? 'https' : 'http'; $destination = "$scheme://{$current_site->domain}{$current_site->path}"; do_action( 'ms_site_not_found', $current_site, $domain, $path ); if ( $subdomain && ! defined( 'NOBLOGREDIRECT' ) ) { $destination .= 'wp-signup.php?new=' . str_replace( '.' . $current_site->domain, '', $domain ); } elseif ( $subdomain ) { if ( '%siteurl%' !== NOBLOGREDIRECT ) { $destination = NOBLOGREDIRECT; } } elseif ( 0 === strcasecmp( $current_site->domain, $domain ) ) { return false; } return $destination; } if ( empty( $current_site->blog_id ) ) { $current_site->blog_id = get_main_site_id( $current_site->id ); } return true; } function ms_not_installed( $domain, $path ) { global $wpdb; if ( ! is_admin() ) { dead_db(); } wp_load_translations_early(); $title = __( 'Error establishing a database connection' ); $msg = '<h1>' . $title . '</h1>'; $msg .= '<p>' . __( 'If your site does not display, please contact the owner of this network.' ) . ''; $msg .= ' ' . __( 'If you are the owner of this network please check that your host&#8217;s database server is running properly and all tables are error free.' ) . '</p>'; $query = $wpdb->prepare( 'SHOW TABLES LIKE %s', $wpdb->esc_like( $wpdb->site ) ); if ( ! $wpdb->get_var( $query ) ) { $msg .= '<p>' . sprintf( __( '<strong>Database tables are missing.</strong> This means that your host&#8217;s database server is not running, WordPress was not installed properly, or someone deleted %s. You really should look at your database now.' ), '<code>' . $wpdb->site . '</code>' ) . '</p>'; } else { $msg .= '<p>' . sprintf( __( '<strong>Could not find site %1$s.</strong> Searched for table %2$s in database %3$s. Is that right?' ), '<code>' . rtrim( $domain . $path, '/' ) . '</code>', '<code>' . $wpdb->blogs . '</code>', '<code>' . DB_NAME . '</code>' ) . '</p>'; } $msg .= '<p><strong>' . __( 'What do I do now?' ) . '</strong> '; $msg .= sprintf( __( 'Read the <a href="%s" target="_blank">Debugging a WordPress Network</a> article. Some of the suggestions there may help you figure out what went wrong.' ), __( 'https://wordpress.org/documentation/article/debugging-a-wordpress-network/' ) ); $msg .= ' ' . __( 'If you are still stuck with this message, then check that your database contains the following tables:' ) . '</p><ul>'; foreach ( $wpdb->tables( 'global' ) as $t => $table ) { if ( 'sitecategories' === $t ) { continue; } $msg .= '<li>' . $table . '</li>'; } $msg .= '</ul>'; wp_die( $msg, $title, array( 'response' => 500 ) ); } function get_current_site_name( $current_site ) { _deprecated_function( __FUNCTION__, '3.9.0', 'get_current_site()' ); return $current_site; } function wpmu_current_site() { global $current_site; _deprecated_function( __FUNCTION__, '3.9.0' ); return $current_site; } function wp_get_network( $network ) { _deprecated_function( __FUNCTION__, '4.7.0', 'get_network()' ); $network = get_network( $network ); if ( null === $network ) { return false; } return $network; } 